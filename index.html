<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Volleyball Matches</title>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
        max-width: 1600px;
        margin: 2rem auto;
        background: #131010;
        padding: 0 1rem;
      }
      h1 {
        color: #b8b2b2;
        text-align: center;
      }
      .container {
        display: flex;
        gap: 1rem;
      }
      .column {
        flex: 1;
        min-width: 0;
      }
      h2 {
        color: #b8b2b2;
        margin-top: 0;
      }
      pre {
        background: #212529;
        padding: 1rem;
        border-radius: 8px;
        overflow-x: auto;
        color: #b8b2b2;
      }
      .error {
        color: #c00;
      }
    </style>
  </head>
  <body>
    <h1>Volleyball Matches</h1>
    <div class="container">
      <div class="column">
        <h2>Live Matches</h2>
        <pre id="live-output">Loading...</pre>
      </div>
      <div class="column">
        <h2>Today's Schedule</h2>
        <pre id="schedule-output">Loading...</pre>
      </div>
    </div>
    <script>
      async function fetchLiveMatches() {
        const output = document.getElementById("live-output");
        try {
          const response = await fetch(
            "https://api.volleyballdatabased.com/matches"
          );
          const data = await response.json();
          const timestamp = new Date().toLocaleTimeString();

          let formatted = `Last updated: ${timestamp}\n\n`;
          formatted += `Total matches: ${data.length}\n\n`;

          data.forEach((match, index) => {
            formatted += `Match ${index + 1}:\n`;
            formatted += `  ${match.t1} vs ${match.t2}\n`;
            formatted += `  Sets: ${match.t1_sets_won} - ${match.t2_sets_won}\n`;
            formatted += `  Scores: ${match.t1_set1}-${match.t2_set1}; ${match.t1_set2}-${match.t2_set2}; ${match.t1_set3}-${match.t2_set3}; ${match.t1_set4}-${match.t2_set4}; ${match.t1_set5}-${match.t2_set5}\n`;
            formatted += `  URL: ${match.match_url}\n`;
            formatted += `  Updated: ${match.last_updated}\n\n`;
          });

          output.textContent = formatted;
        } catch (error) {
          output.innerHTML = `<span class="error">No live matches being played</span>`;
        }
      }

      async function fetchTodaySchedule() {
        const output = document.getElementById("schedule-output");
        try {
          const response = await fetch(
            "https://api.volleyballdatabased.com/sb_daily"
          );
          const data = await response.json();

          const today = new Date().toISOString().split("T")[0];
          const todayMatches = data.filter((match) => {
            const matchDate = match.date_added.split("T")[0];
            return matchDate === today;
          });

          // Parse time strings and convert to UTC for sorting
          const parseTime = (timeStr) => {
            if (!timeStr) return null;

            // Extract time and timezone
            const timeMatch = timeStr.match(
              /(\d{1,2}):(\d{2})\s*(AM|PM)?\s*(ET|EST|CST|MST|PST|PT)?/i
            );
            if (!timeMatch) return null;

            let [, hours, minutes, ampm, tz] = timeMatch;
            hours = parseInt(hours);
            minutes = parseInt(minutes);

            // Convert to 24-hour format
            if (ampm && ampm.toUpperCase() === "PM" && hours !== 12)
              hours += 12;
            if (ampm && ampm.toUpperCase() === "AM" && hours === 12) hours = 0;

            // Timezone offsets to UTC
            const tzOffsets = {
              ET: -5,
              EST: -5,
              CST: -6,
              MST: -7,
              PT: -8,
              PST: -8,
            };

            const offset = tzOffsets[tz?.toUpperCase()] || -7; // Default to MST
            const utcHours = hours - offset;

            return utcHours * 60 + minutes;
          };

          // Sort by time
          todayMatches.sort((a, b) => {
            const timeA = parseTime(a.time);
            const timeB = parseTime(b.time);

            if (timeA === null) return 1;
            if (timeB === null) return -1;
            return timeA - timeB;
          });

          const timestamp = new Date().toLocaleTimeString();

          let formatted = `Today's date: ${today}\n`;
          formatted += `Total matches: ${todayMatches.length}\n\n`;

          todayMatches.forEach((match, index) => {
            formatted += `Match ${index + 1}:\n`;
            formatted += `  Time: ${match.time || "TBD"}\n`;
            formatted += `  URL: ${match.url}\n\n`;
          });

          output.textContent = formatted;
        } catch (error) {
          output.innerHTML = `<span class="error">Error: ${error.message}</span>`;
        }
      }

      function fetchAll() {
        fetchLiveMatches();
        fetchTodaySchedule();
      }

      fetchAll();
      setInterval(fetchAll, 15 * 1000);
    </script>
  </body>
</html>
